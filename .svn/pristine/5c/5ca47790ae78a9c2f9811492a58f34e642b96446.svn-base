import requests
import json
import time
import os
from typing import Dict, List, Optional, Tuple
from urllib.parse import quote

class AlistClient:
    def __init__(self, base_url: str, max_retries: int = 5, retry_delay: float = 1.0):
        self.base_url = base_url.rstrip('/')
        self.session = requests.Session()
        self.max_retries = max_retries
        self.retry_delay = retry_delay
        
        # æ–‡ä»¶ç±»å‹å›¾æ ‡æ˜ å°„
        self.file_icons = {
            # è§†é¢‘æ–‡ä»¶
            'video': 'ğŸ¬',
            'mp4': 'ğŸ¬',
            'mkv': 'ğŸ¬',
            'avi': 'ğŸ¬',
            'mov': 'ğŸ¬',
            
            # éŸ³é¢‘æ–‡ä»¶
            'audio': 'ğŸµ',
            'mp3': 'ğŸµ',
            'wav': 'ğŸµ',
            'flac': 'ğŸµ',
            
            # å›¾ç‰‡æ–‡ä»¶
            'image': 'ğŸ–¼ï¸',
            'jpg': 'ğŸ–¼ï¸',
            'jpeg': 'ğŸ–¼ï¸',
            'png': 'ğŸ–¼ï¸',
            'gif': 'ğŸ–¼ï¸',
            'webp': 'ğŸ–¼ï¸',
            
            # æ–‡æ¡£æ–‡ä»¶
            'pdf': 'ğŸ“„',
            'doc': 'ğŸ“',
            'docx': 'ğŸ“',
            'xls': 'ğŸ“Š',
            'xlsx': 'ğŸ“Š',
            'ppt': 'ğŸ“½ï¸',
            'pptx': 'ğŸ“½ï¸',
            'txt': 'ğŸ“',
            
            # å‹ç¼©æ–‡ä»¶
            'zip': 'ğŸ“¦',
            'rar': 'ğŸ“¦',
            'tar': 'ğŸ“¦',
            '7z': 'ğŸ“¦',
            'gz': 'ğŸ“¦',
            
            # ä»£ç æ–‡ä»¶
            'py': 'ğŸ',
            'java': 'â˜•',
            'js': 'ğŸ“œ',
            'html': 'ğŸŒ',
            'css': 'ğŸ¨',
            'json': 'ğŸ“‹',
            
            # ç³»ç»Ÿæ–‡ä»¶
            'exe': 'âš™ï¸',
            'msi': 'âš™ï¸',
            'dmg': 'âš™ï¸',
            'iso': 'ğŸ’¿',
            'img': 'ğŸ’¿',
            
            # é»˜è®¤æ–‡ä»¶
            'default': 'ğŸ“„',
            'directory': 'ğŸ“'
        }

    def get_file_type(self, filename: str) -> str:
        """æ ¹æ®æ–‡ä»¶åè·å–æ–‡ä»¶ç±»å‹"""
        if '.' not in filename:
            return 'default'
        ext = filename.split('.')[-1].lower()
        return ext if ext in self.file_icons else 'default'

    def get_file_icon(self, filename: str, is_dir: bool = False) -> str:
        """è·å–æ–‡ä»¶å›¾æ ‡"""
        if is_dir:
            return self.file_icons['directory']
        return self.file_icons.get(self.get_file_type(filename), self.file_icons['default'])

    def encode_path(self, path: str) -> str:
        """å¯¹è·¯å¾„è¿›è¡ŒURLç¼–ç ï¼Œä¿ç•™æ–œæ å’Œä¸­æ–‡"""
        # åˆ†å‰²è·¯å¾„å¹¶å•ç‹¬ç¼–ç æ¯ä¸ªéƒ¨åˆ†
        parts = path.split('/')
        encoded_parts = []
        for part in parts:
            if part:
                # å¯¹ç©ºæ ¼è¿›è¡Œç‰¹æ®Šå¤„ç†ï¼Œæ›¿æ¢ä¸º %20
                part = part.replace(' ', '%20')
                # å…¶ä»–ç‰¹æ®Šå­—ç¬¦ä¸ç¼–ç 
                encoded_parts.append(part)
        return '/' + '/'.join(encoded_parts)

    def get_file_list(self, path: str = '/', retry_count: int = 0) -> Optional[Dict]:
        """è·å–æŒ‡å®šè·¯å¾„ä¸‹çš„æ–‡ä»¶åˆ—è¡¨"""
        api_url = f"{self.base_url}/api/fs/list"
        
        # å¯¹è·¯å¾„è¿›è¡Œå¤„ç†
        processed_path = path.replace(' ', '%20')
        
        data = {
            "path": processed_path,
            "password": "",
            "page": 1,
            "per_page": 100,
            "refresh": False
        }
        
        try:
            if retry_count > 0:
                time.sleep(self.retry_delay)
            
            response = self.session.post(api_url, json=data)
            response.raise_for_status()
            result = response.json()
            
            if result.get('code') != 200:
                error_msg = result.get('message', 'æœªçŸ¥é”™è¯¯')
                if 'å¯†ç ' in error_msg or 'password' in error_msg.lower():
                    for password in ['123456', '666666', '000000']:
                        data['password'] = password
                        response = self.session.post(api_url, json=data)
                        result = response.json()
                        if result.get('code') == 200:
                            return result
                
                # å¦‚æœä½¿ç”¨ %20 å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨ +
                if 'storage not found' in error_msg:
                    data['path'] = path.replace(' ', '+')
                    response = self.session.post(api_url, json=data)
                    result = response.json()
                    if result.get('code') == 200:
                        return result
                
                raise requests.exceptions.RequestException(f"APIè¿”å›é”™è¯¯: {error_msg}")
            
            return result
            
        except requests.exceptions.RequestException as e:
            print(f"è·å–è·¯å¾„ '{path}' çš„æ–‡ä»¶åˆ—è¡¨æ—¶å‘ç”Ÿé”™è¯¯: {e}")
            
            if retry_count < self.max_retries:
                print(f"ç­‰å¾… {self.retry_delay} ç§’åé‡è¯•... (ç¬¬ {retry_count + 1} æ¬¡é‡è¯•)")
                return self.get_file_list(path, retry_count + 1)
            
            return {
                'code': 200,
                'message': 'success',
                'data': {
                    'content': [],
                    'total': 0
                }
            }

    def get_file_url(self, path: str, retry_count: int = 0) -> Optional[str]:
        """è·å–æ–‡ä»¶çš„ä¸‹è½½é“¾æ¥"""
        api_url = f"{self.base_url}/api/fs/get"
        
        # å¯¹è·¯å¾„è¿›è¡Œå¤„ç†
        processed_path = path.replace(' ', '%20')
        
        data = {
            "path": processed_path,
            "password": ""
        }
        
        try:
            response = self.session.post(api_url, json=data)
            response.raise_for_status()
            result = response.json()
            
            if result.get('code') != 200:
                # å¦‚æœ %20 å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨ +
                data['path'] = path.replace(' ', '+')
                response = self.session.post(api_url, json=data)
                result = response.json()
                
                if result.get('code') != 200:
                    raise requests.exceptions.RequestException(f"APIè¿”å›é”™è¯¯: {result.get('message', 'æœªçŸ¥é”™è¯¯')}")
            
            return result.get('data', {}).get('raw_url')
            
        except requests.exceptions.RequestException as e:
            if retry_count < self.max_retries:
                print(f"ç­‰å¾… {self.retry_delay} ç§’åé‡è¯•... (ç¬¬ {retry_count + 1} æ¬¡é‡è¯•)")
                time.sleep(self.retry_delay)
                return self.get_file_url(path, retry_count + 1)
            
            return None

    def print_file_list(self, path: str = '/', depth: int = 0, max_depth: int = -1, get_urls: bool = False):
        """é€’å½’æ‰“å°æ–‡ä»¶åˆ—è¡¨ï¼Œå¯é€‰æ‹©æ˜¯å¦è·å–æ–‡ä»¶URL"""
        result = self.get_file_list(path)
        indent = "  " * depth
        
        content = result.get('data', {}).get('content', [])
        
        # æ‰“å°å½“å‰è·¯å¾„
        if depth == 0 or len(content) > 0:  # åªåœ¨æ ¹ç›®å½•æˆ–æœ‰å†…å®¹æ—¶æ˜¾ç¤ºè·¯å¾„
            print(f"\n{indent}ğŸ“‚ è·¯å¾„: {path}")
            print(f"{indent}" + "-" * 30)
        
        try:
            for item in content:
                is_dir = item['is_dir']
                name = item['name']
                current_path = f"{path.rstrip('/')}/{name}"
                
                # è·å–æ–‡ä»¶å›¾æ ‡
                icon = self.get_file_icon(name, is_dir)
                
                # æ‰“å°å½“å‰é¡¹ç›®
                size_str = f" ({self.format_size(item.get('size', 0))})" if not is_dir else ""
                print(f"{indent}{icon} {name}{size_str}")
                
                # å¦‚æœæ˜¯æ–‡ä»¶ä¸”éœ€è¦è·å–URL
                if not is_dir and get_urls:
                    file_url = self.get_file_url(current_path)
                    if file_url:
                        print(f"{indent}  ğŸ”— URL: {file_url}")
                    else:
                        print(f"{indent}  âŒ URLè·å–å¤±è´¥")
                
                # å¦‚æœæ˜¯ç›®å½•ä¸”æœªè¾¾åˆ°æœ€å¤§æ·±åº¦ï¼Œåˆ™é€’å½’è·å–
                if is_dir and (max_depth == -1 or depth < max_depth):
                    sub_result = self.get_file_list(current_path)
                    if sub_result and sub_result.get('data', {}).get('content'):
                        self.print_file_list(current_path, depth + 1, max_depth, get_urls)
                    else:
                        print(f"{indent}  âš ï¸ ç›®å½•ä¸ºç©ºæˆ–æ— æ³•è®¿é—®")
            
            if depth == 0:
                print(f"\næ€»è®¡: {len(content)} ä¸ªé¡¹ç›®")
                
        except Exception as e:
            print(f"{indent}å¤„ç†æ–‡ä»¶åˆ—è¡¨æ—¶å‘ç”Ÿé”™è¯¯: {e}")

    def format_size(self, size_in_bytes: int) -> str:
        """æ ¼å¼åŒ–æ–‡ä»¶å¤§å°"""
        for unit in ['B', 'KB', 'MB', 'GB', 'TB']:
            if size_in_bytes < 1024:
                return f"{size_in_bytes:.2f}{unit}"
            size_in_bytes /= 1024
        return f"{size_in_bytes:.2f}PB"

    def get_all_files_info(self, path: str = '/', include_dirs: bool = False, depth: int = 0, max_depth: int = -1) -> List[Dict]:
        """è·å–æ‰€æœ‰æ–‡ä»¶çš„ä¿¡æ¯ï¼ˆåŒ…æ‹¬URLï¼‰"""
        result = self.get_file_list(path)
        files_info = []
        
        content = result.get('data', {}).get('content', [])
        
        try:
            for item in content:
                is_dir = item['is_dir']
                name = item['name']
                current_path = f"{path.rstrip('/')}/{name}"
                
                if is_dir:
                    if include_dirs:
                        files_info.append({
                            'name': name,
                            'path': current_path,
                            'encoded_path': self.encode_path(current_path),  # æ·»åŠ ç¼–ç åçš„è·¯å¾„
                            'type': 'directory',
                            'icon': self.get_file_icon(name, True),
                            'accessible': True  # æ·»åŠ å¯è®¿é—®æ€§æ ‡è®°
                        })
                    if max_depth == -1 or depth < max_depth:
                        try:
                            sub_result = self.get_file_list(current_path)
                            if sub_result and sub_result.get('data', {}).get('content'):
                                sub_files = self.get_all_files_info(
                                    current_path, 
                                    include_dirs,
                                    depth + 1,
                                    max_depth
                                )
                                files_info.extend(sub_files)
                            else:
                                # æ›´æ–°ç›®å½•çš„å¯è®¿é—®æ€§çŠ¶æ€
                                if include_dirs:
                                    for f in files_info:
                                        if f['path'] == current_path:
                                            f['accessible'] = False
                                            break
                        except Exception as e:
                            print(f"è·å–ç›®å½• '{current_path}' æ—¶å‘ç”Ÿé”™è¯¯: {e}")
                else:
                    try:
                        file_url = self.get_file_url(current_path)
                        file_type = self.get_file_type(name)
                        file_info = {
                            'name': name,
                            'path': current_path,
                            'encoded_path': self.encode_path(current_path),  # æ·»åŠ ç¼–ç åçš„è·¯å¾„
                            'type': file_type,
                            'icon': self.get_file_icon(name, False),
                            'size': item.get('size', 0),
                            'size_formatted': self.format_size(item.get('size', 0)),
                            'modified': item.get('modified', ''),
                            'url': file_url,
                            'accessible': bool(file_url)  # æ ¹æ®æ˜¯å¦èƒ½è·å–URLåˆ¤æ–­å¯è®¿é—®æ€§
                        }
                        files_info.append(file_info)
                    except Exception as e:
                        print(f"è·å–æ–‡ä»¶ '{current_path}' ä¿¡æ¯æ—¶å‘ç”Ÿé”™è¯¯: {e}")
                        
        except Exception as e:
            print(f"å¤„ç†è·¯å¾„ '{path}' æ—¶å‘ç”Ÿé”™è¯¯: {e}")
        
        return files_info

def main():
    alist_url = "https://pan.xiaolibai.cn"
    client = AlistClient(alist_url, max_retries=5, retry_delay=1.0)
    
    # è®¾ç½®æœ€å¤§é€’å½’æ·±åº¦
    max_depth = 4
    
    print(f"å¼€å§‹è·å–æ–‡ä»¶åˆ—è¡¨ (æœ€å¤§æ·±åº¦: {max_depth if max_depth != -1 else 'æ— é™'})")
    print("æ³¨æ„: âš ï¸ æ ‡è®°è¡¨ç¤ºæ— æ³•è®¿é—®çš„ç›®å½•")
    
    # æ–¹å¼1ï¼šæ‰“å°æ–‡ä»¶åˆ—è¡¨å¹¶æ˜¾ç¤ºURL
    client.print_file_list('/', depth=0, max_depth=max_depth, get_urls=True)
    
    # æ–¹å¼2ï¼šè·å–æ‰€æœ‰æ–‡ä»¶ä¿¡æ¯ï¼ˆåŒ…æ‹¬URLï¼‰å¹¶ä¿å­˜åˆ°JSONæ–‡ä»¶
    print("\næ­£åœ¨è·å–æ‰€æœ‰æ–‡ä»¶ä¿¡æ¯...")
    all_files = client.get_all_files_info('/', include_dirs=True, max_depth=max_depth)
    
    if all_files:
        # ä¿å­˜åˆ°JSONæ–‡ä»¶
        with open('files_info.json', 'w', encoding='utf-8') as f:
            json.dump(all_files, f, ensure_ascii=False, indent=2)
        print(f"æ–‡ä»¶ä¿¡æ¯å·²ä¿å­˜åˆ° files_info.json (å…± {len(all_files)} ä¸ªé¡¹ç›®)")
    else:
        print("æœªè·å–åˆ°ä»»ä½•æ–‡ä»¶ä¿¡æ¯")

if __name__ == "__main__":
    main() 